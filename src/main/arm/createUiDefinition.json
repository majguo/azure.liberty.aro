{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "infoForBeforeDeployment",
                "type": "Microsoft.Common.InfoBox",
                "options": {
                    "icon": "Info",
                    "text": "The Azure identity deploying this offer must have one of the following two sets of Azure role-based access control roles:<br> <li><a href='https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#contributor'>Contributor</a> <b>and</b> <a href='https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#user-access-administrator'>User Access Administrator</a> of the current subscription.</li><li><a href='https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#owner'>Owner</a> of the current subscription.</li>"
                }
            },
            {
                "name": "howToReportIssues",
                "type": "Microsoft.Common.Section",
                "label": "Report issues, get help, and share feedback",
                "elements": [
                    {
                        "name": "howToReportIssueText",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "If you encounter problems during deployment of Liberty on Azure, open an issue.",
                            "link": {
                                "label": "Issue tracker",
                                "uri": "https://aka.ms/azure-liberty-aro-issues?version=${project.version}"
                            }
                        }
                    },
                    {
                        "name": "howToReportVendorIssueText",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "If you have problems with the offer after successful deployment, and you have purchased licenses that entitle you to IBM support for Liberty, open an issue.",
                            "link": {
                                "label": "IBM support",
                                "uri": "https://www.ibm.com/mysupport/"
                            }
                        }
                    },
                    {
                        "name": "howToCommunityHelp",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "If you want to interact directly with the Open Liberty community, check out the community options.",
                            "link": {
                                "label": "Community support",
                                "uri": "https://openliberty.io/support/"
                            }
                        }
                    },
                    {
                        "name": "howToStackOverflow",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "If you want to ask questions about WebSphere Liberty, please use the IBM support option or ask on StackOverflow.",
                            "link": {
                                "label": "StackOverflow",
                                "uri": "https://stackoverflow.com/questions/tagged/websphere-liberty"
                            }
                        }
                    },
                    {
                        "name": "survey",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "To get free help with Azure migration from the development team, fill out this survey.",
                            "link": {
                                "label": "Take survey",
                                "uri": "https://aka.ms/ibm-stack-migration-survey"
                            }
                        }
                    }
                ],
                "visible": true
            }
        ],
        "steps": [
            {
                "name": "Cluster",
                "label": "ARO",
                "subLabel": {
                    "preValidation": "Provide required info for cluster configuration",
                    "postValidation": "Done"
                },
                "bladeTitle": "ARO",
                "elements": [
                    {
                        "name": "createCluster",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Create a new cluster?",
                        "defaultValue": "Yes",
                        "toolTip": "Select 'Yes' to create a new cluster, or select 'No' to provide an existing cluster.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "createClusterInfo",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide information to create a new cluster",
                        "elements": [
                            {
                                "name": "aroVmSizeInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "options": {
                                    "icon": "Info",
                                    "text": "Azure Red Hat OpenShift requires a minimum of 40 cores to create and run an OpenShift cluster. The default VM sizes satisfy the requirement. For more information on customizing the VM size, consult the <a href='https://azure.microsoft.com/pricing/details/openshift/' target='_blank'>Azure Red Hat OpenShift pricing</a>."
                                }
                            },
                            {
                                "name": "masterVmSizeSelect",
                                "type": "Microsoft.Compute.SizeSelector",
                                "label": "Master VM size",
                                "toolTip": "The size of the virtual machines for the master nodes in the cluster.",
                                "recommendedSizes": [
                                    "Standard_D8s_v3"
                                ],
                                "osPlatform": "Linux",
                                "count": 3
                            },
                            {
                                "name": "workerVmSizeSelect",
                                "type": "Microsoft.Compute.SizeSelector",
                                "label": "Worker VM size",
                                "toolTip": "The size of the virtual machines for the worker nodes in the cluster.",
                                "recommendedSizes": [
                                    "Standard_D4s_v3"
                                ],
                                "osPlatform": "Linux",
                                "count": "[int(steps('Cluster').createClusterInfo.minWorkerCount)]"
                            },
                            {
                                "name": "minWorkerCount",
                                "type": "Microsoft.Common.Slider",
                                "min": 3,
                                "max": "[int(steps('Cluster').createClusterInfo.maxWorkerCount)]",
                                "label": "Minimum worker node count",
                                "defaultValue": 3,
                                "showStepMarkers": false,
                                "toolTip": "Set the minimum worker node count for the cluster.",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "maxWorkerCount",
                                "type": "Microsoft.Common.Slider",
                                "min": "[int(steps('Cluster').createClusterInfo.minWorkerCount)]",
                                "max": 100,
                                "label": "Maximum worker node count",
                                "defaultValue": 10,
                                "showStepMarkers": false,
                                "toolTip": "Set the maximum worker node count for the cluster.",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "pullSecret",
                                "type": "Microsoft.Common.PasswordBox",
                                "label": {
                                    "password": "Red Hat pull secret",
                                    "confirmPassword": "Confirm secret"
                                },
                                "toolTip": "The pull secret text that you obtained from the Red Hat OpenShift Cluster Manager website.<br><br>To get pull secret text, see <a href='https://docs.microsoft.com/azure/openshift/tutorial-create-cluster#get-a-red-hat-pull-secret-optional' target='_blank'>Get a Red Hat pull secret</a>.",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "aroSpInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "options": {
                                    "icon": "Info",
                                    "text": "An Azure Active Directory service principal is required for cluster creation. For more information on creating a service<br>principal, consult the <a href='https://aka.ms/aro/sp-docs' target='_blank'>Azure Red Hat OpenShift product documentation</a>.<br><br>For your convenience, you can create the service principal using the following Azure CLI command with a local install or<br>an Azure Cloud Shell. Copy the value of the <b>clientId</b> and <b>clientSecret</b> output from the following command into the<br>corresponding fields below. <br></br><code><b>out=sp-$(date +%s).json && az ad sp create-for-rbac --sdk-auth > ${out} && sleep 30 \\<br>&& cat ${out} | tr -d '\",' && rm -rf ${out}</b></code> <!-- https://github.com/WASdev/azure.liberty.aro/issues/79 -->"
                                }
                            },
                            {
                                "name": "aadClientId",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Service principal client ID",
                                "toolTip": "The client ID of an existing service principal",
                                "constraints": {
                                    "required": true,
                                    "regex": "^[0-9A-Fa-f]{8}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{4}[-][0-9A-Fa-f]{12}$",
                                    "validationMessage": "The application (client) ID must be a valid global unique identifier (GUID). Example: 00000000-0000-0000-0000-000000000000"
                                }
                            },
                            {
                                "name": "aadClientSecret",
                                "type": "Microsoft.Common.PasswordBox",
                                "label": {
                                    "password": "Service principal client secret",
                                    "confirmPassword": "Confirm secret"
                                },
                                "toolTip": "The client secret of an existing service principal",
                                "constraints": {
                                    "required": true
                                }
                            },
                            {
                                "name": "UserSPGraphRequest",
                                "type": "Microsoft.Solutions.GraphApiControl",
                                "toolTip": "Obtain the objectId of the service principal",
                                "condition": "[not(empty(steps('Cluster').createClusterInfo.aadClientId))]",
                                "request": {
                                    "method": "GET",
                                    "path": "[concat('v1.0/servicePrincipals?$filter=appId eq \\'', steps('Cluster').createClusterInfo.aadClientId, '\\'')]",
                                    "transforms": {
                                        "objectID": "value|[*].id"
                                    }
                                }
                            },
                            {
                                "name": "RPObjectIDGraphRequest",
                                "type": "Microsoft.Solutions.GraphApiControl",
                                "toolTip": "Obtain the objectId of the Azure Red Hat OpenShift RP service principal",
                                "request": {
                                    "method": "GET",
                                    "path": "v1.0/servicePrincipals?$filter=appId eq 'f1dd0a37-89c6-4e07-bcd1-ffd3d43d8875'",
                                    "transforms": {
                                        "objectID": "value|[*].id"
                                    }
                                }
                            }
                        ],
                        "visible": "[bool(steps('Cluster').createCluster)]"
                    },
                    {
                        "name": "clusterInfo",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide information for an existing cluster",
                        "elements": [
                            {
                                "name": "errInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "visible": "[equals(length(steps('Cluster').clusterInfo.clusterSelector.id), 0)]",
                                "options": {
                                    "icon": "Error",
                                    "text": "You must select an existing Azure Red Hat OpenShift cluster in current subscription and location."
                                }
                            },
                            {
                                "name": "clusterSelector",
                                "type": "Microsoft.Solutions.ResourceSelector",
                                "label": "Select cluster",
                                "toolTip": "Select the existing cluster.",
                                "resourceType": "Microsoft.RedHatOpenShift/OpenShiftClusters",
                                "options": {
                                    "filter": {
                                        "subscription": "onBasics",
                                        "location": "onBasics"
                                    }
                                }
                            }
                        ],
                        "visible": "[not(bool(steps('Cluster').createCluster))]"
                    }
                ]
            },
            {
                "name": "Application",
                "label": "Operator and application",
                "subLabel": {
                    "preValidation": "Provide required info for Operator and application",
                    "postValidation": "Done"
                },
                "bladeTitle": "Operator and application",
                "elements": [
                    {
                        "name": "deployWLO",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "IBM supported?",
                        "defaultValue": "No",
                        "toolTip": "Select 'Yes' if your deployments are to be supported under existing WebSphere entitlements (this includes supported deployments of Open Liberty). Select 'Yes' if you are deploying WebSphere Liberty under the Trial license terms. Select 'No' if you are deploying Open Liberty unsupported.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "deployApplication",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Deploy an application?",
                        "defaultValue": "No",
                        "toolTip": "Select 'Yes' to deploy an application, or select 'No' if you prefer to manually deploy application later.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true
                        }
                    },
                    {
                        "name": "licenseInfo",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "I accept the terms on the license agreement corresponding to the version of IBM Program in the application container<br>by setting this value to true. See <a href='https://ibm.biz/was-license' target='_blank'>https://ibm.biz/was-license</a> for the license agreement applicable to this IBM Program.<br>You must accept the license for the installation to work."
                        },
                        "visible": "[and(bool(steps('Application').deployWLO), bool(steps('Application').deployApplication))]"
                    },
                    {
                        "name": "acceptIBMLicenseAgreement",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Accept license",
                        "toolTip": "Select to accept the License Agreement.",
                        "constraints": {
                            "required": true,
                            "validationMessage": "The deployment will not proceed unless you accept the License Agreement."
                        },
                        "visible": "[and(bool(steps('Application').deployWLO), bool(steps('Application').deployApplication))]"
                    },
                    {
                        "name": "edition",
                        "type": "Microsoft.Common.OptionsGroup",
                        "defaultValue": "IBM WebSphere Application Server",
                        "label": "Edition",
                        "toolTip": "Product edition",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "IBM WebSphere Application Server",
                                    "value": "IBM WebSphere Application Server"
                                },
                                {
                                    "label": "IBM WebSphere Application Server Liberty Core",
                                    "value": "IBM WebSphere Application Server Liberty Core"
                                },
                                {
                                    "label": "IBM WebSphere Application Server Network Deployment",
                                    "value": "IBM WebSphere Application Server Network Deployment"
                                }
                            ],
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployWLO), bool(steps('Application').deployApplication))]"
                    },
                    {
                        "name": "productEntitlementSource",
                        "type": "Microsoft.Common.OptionsGroup",
                        "defaultValue": "Standalone",
                        "label": "Product entitlement source",
                        "toolTip": "Entitlement source for the product",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Standalone",
                                    "value": "Standalone"
                                },
                                {
                                    "label": "IBM WebSphere Hybrid Edition",
                                    "value": "IBM WebSphere Hybrid Edition"
                                },
                                {
                                    "label": "IBM Cloud Pak for Applications",
                                    "value": "IBM Cloud Pak for Applications"
                                },
                                {
                                    "label": "IBM WebSphere Application Server Family Edition",
                                    "value": "IBM WebSphere Application Server Family Edition"
                                }
                            ],
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployWLO), bool(steps('Application').deployApplication))]"
                    },
                    {
                        "name": "appImageInfo",
                        "type": "Microsoft.Common.Section",
                        "label": "Provide application deployment information",
                        "elements": [
                            {
                                "name": "appImageOption",
                                "type": "Microsoft.Common.OptionsGroup",
                                "label": "Deploy your own application or a sample application?",
                                "defaultValue": "Your own application image",
                                "toolTip": "Depoly an application image on top of Open Liberty or WebSphere Liberty base image.",
                                "constraints": {
                                    "allowedValues": [
                                        {
                                            "label": "Your own application image",
                                            "value": "1"
                                        },
                                        {
                                            "label": "The Open Liberty sample image: icr.io/appcafe/open-liberty/samples/getting-started (details on sample application here: https://github.com/OpenLiberty/sample-getting-started)",
                                            "value": "2"
                                        }
                                    ],
                                    "required": true
                                }
                            },
                            {
                                "name": "imagePathInfo",
                                "type": "Microsoft.Common.InfoBox",
                                "options": {
                                    "icon": "Info",
                                    "text": "Please provide a public image which is accessible without credentials. If you input a fully qualified container image path<br>containing the registry login server, it's used directly. Otherwise, the login server is assumed to be 'docker.io'.<br>For example, 'websphere-liberty' will be converted to 'docker.io/library/websphere-liberty',<br>and 'ibmcom/websphere-liberty' will be converted to 'docker.io/ibmcom/websphere-liberty'."
                                },
                                "visible": "[equals(steps('Application').appImageInfo.appImageOption, '1')]"
                            },
                            {
                                "name": "appImagePath",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Application container image path",
                                "placeholder": "Example: docker.io/openliberty/open-liberty:full-java11-openj9-ubi",
                                "toolTip": "Specify the container image path of your application.",
                                "constraints": {
                                    "required": true,
                                    "regex": "^(?:(?=[^:\/]{4,253})(?!-)[a-zA-Z0-9-]{1,63}(?<!-)(?:\\.(?!-)[a-zA-Z0-9-]{1,63}(?<!-))*(?::[0-9]{1,5})?/)?((?![._-])(?:[a-z0-9._-]*)(?<![._-])(?:/(?![._-])[a-z0-9._-]*(?<![._-]))*)(?::(?![.-])[a-zA-Z0-9_.-]{1,128})?$",
                                    "validationMessage": "The value must be a valid container image path. For example, docker.io/openliberty/open-liberty:full-java11-openj9-ubi"
                                },
                                "visible": "[equals(steps('Application').appImageInfo.appImageOption, '1')]"
                            }
                        ],
                        "visible": "[bool(steps('Application').deployApplication)]"
                    },
                    {
                        "name": "autoScaling",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Auto-scale replicas?",
                        "defaultValue": "No",
                        "toolTip": "Select 'Yes' to automatically create or delete instances based on resource consumption, or select 'No' to specify static instances.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "true"
                                },
                                {
                                    "label": "No",
                                    "value": "false"
                                }
                            ],
                            "required": true 
                        },
                        "visible": "[bool(steps('Application').deployApplication)]"
                    },
                    {
                        "name": "cpuUtilizationPercentage",
                        "type": "Microsoft.Common.Slider",
                        "min": 1,
                        "max": 100,
                        "label": "Target average CPU utilization",
                        "subLabel": "percentage",
                        "defaultValue": 80,
                        "showStepMarkers": false,
                        "toolTip": "Set the target average CPU utilization (percentage) over all the replicas.",
                        "constraints": {
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployApplication), bool(steps('Application').autoScaling))]"
                    },
                    {
                        "name": "minReplicas",
                        "type": "Microsoft.Common.Slider",
                        "min": 1,
                        "max": "[int(steps('Application').maxReplicas)]",
                        "label": "Minimum application replicas",
                        "defaultValue": 1,
                        "showStepMarkers": false,
                        "toolTip": "Set the minimum number of application replicas.",
                        "constraints": {
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployApplication), bool(steps('Application').autoScaling))]"
                    },
                    {
                        "name": "maxReplicas",
                        "type": "Microsoft.Common.Slider",
                        "min": "[int(steps('Application').minReplicas)]",
                        "max": 100,
                        "label": "Maximum application replicas",
                        "showStepMarkers": false,
                        "toolTip": "Set the maximum number of application replicas.",
                        "constraints": {
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployApplication), bool(steps('Application').autoScaling))]"
                    },
                    {
                        "name": "requestCPUMillicore",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Minimum required CPU core (millicore)",
                        "showStepMarkers": false,
                        "toolTip": "Set the minimum required CPU core (millicore) over all the replicas.",
                        "constraints": {
                            "required": true,
                            "validations": [
                                {
                                  "regex": "^[1-9][0-9]*$",
                                  "message": "Only positive numbers are allowed."
                                }
                              ]
                        },
                        "visible": "[and(bool(steps('Application').deployApplication), bool(steps('Application').autoScaling))]"
                    },
                    {
                        "name": "appReplicas",
                        "type": "Microsoft.Common.Slider",
                        "min": 1,
                        "max": 20,
                        "label": "Number of application replicas",
                        "defaultValue": 2,
                        "showStepMarkers": false,
                        "toolTip": "The number of application replicas to deploy.",
                        "constraints": {
                            "required": true
                        },
                        "visible": "[and(bool(steps('Application').deployApplication), not(bool(steps('Application').autoScaling)))]"
                    }
                ]
            }
        ],
        "outputs": {
            "location": "[location()]",
            "createCluster": "[bool(steps('Cluster').createCluster)]",
            "vmSize": "[steps('Cluster').createClusterInfo.masterVmSizeSelect]",
            "workerVmSize": "[steps('Cluster').createClusterInfo.workerVmSizeSelect]",
            "minWorkerCount": "[int(steps('Cluster').createClusterInfo.minWorkerCount)]",
            "maxWorkerCount": "[int(steps('Cluster').createClusterInfo.maxWorkerCount)]",
            "pullSecret": "[steps('Cluster').createClusterInfo.pullSecret]",
            "aadClientId": "[steps('Cluster').createClusterInfo.aadClientId]",
            "aadClientSecret": "[steps('Cluster').createClusterInfo.aadClientSecret]",
            "aadObjectId": "[first(steps('Cluster').createClusterInfo.UserSPGraphRequest.transformed.objectID)]",
            "rpObjectId": "[first(steps('Cluster').createClusterInfo.RPObjectIDGraphRequest.transformed.objectID)]",
            "clusterName": "[last(split(steps('Cluster').clusterInfo.clusterSelector.id, '/'))]",
            "clusterRGName": "[last(take(split(steps('Cluster').clusterInfo.clusterSelector.id, '/'), 5))]",
            "deployWLO": "[bool(steps('Application').deployWLO)]",
            "edition": "[steps('Application').edition]",
            "productEntitlementSource": "[steps('Application').productEntitlementSource]",
            "deployApplication": "[bool(steps('Application').deployApplication)]",
            "appImagePath": "[if(equals(steps('Application').appImageInfo.appImageOption, '2'), 'icr.io/appcafe/open-liberty/samples/getting-started', if(equals(steps('Application').appImageInfo.appImageOption, '3'), 'docker.io/ibmcom/websphere-liberty-sample:1.0.0', steps('Application').appImageInfo.appImagePath))]",
            "autoScaling": "[bool(steps('Application').autoScaling)]",
            "cpuUtilizationPercentage": "[int(steps('Application').cpuUtilizationPercentage)]",
            "minReplicas": "[int(steps('Application').minReplicas)]",
            "maxReplicas": "[int(steps('Application').maxReplicas)]",
            "requestCPUMillicore": "[int(steps('Application').requestCPUMillicore)]",
            "appReplicas": "[int(steps('Application').appReplicas)]"
        }
    }
}
